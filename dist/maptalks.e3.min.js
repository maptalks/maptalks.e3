/*!
 * maptalks.e3 v0.4.6
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@^0.25.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("echarts")):"function"==typeof define&&define.amd?define(["exports","maptalks","echarts"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.echarts)}(this,function(t,o,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var o=n[i],r=Object.getOwnPropertyDescriptor(e,o);r&&r.configurable&&void 0===t[o]&&Object.defineProperty(t,o,r)}}(t,e))}var n=function(o){function r(t,e,n){s(this,r);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,o.call(this,t,n));return i._ecOptions=e,i}return e(r,o),r.prototype.getEChartsOption=function(){return this._ecOptions},r.prototype.setEChartsOption=function(t){return this._ecOptions=t,this._getRenderer()&&this._getRenderer()._clearAndRedraw(),this},r.prototype.getEchartsInstance=function(){return this._getRenderer()&&(this._EC=this._getRenderer().getEC()),this._EC||null},r.prototype.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),ecOptions:this._ecOptions,options:this.config()}},r.fromJSON=function(t){return t&&"E3Layer"===t.type?new r(t.id,t.ecOptions,t.options):null},r}(o.Layer);n.mergeOptions({container:"front",renderer:"dom",hideOnZooming:!1,hideOnMoving:!1,hideOnRotating:!1}),n.registerJSONType("E3Layer"),n.registerRenderer("dom",function(){function e(t){s(this,e),this.layer=t}return e.prototype.render=function(){this._container||this._createLayerContainer(),this._ec?this._isVisible()&&this._ec.resize():(this._ec=i.init(this._container),this._prepareECharts(),this._ec.setOption(this.layer._ecOptions,!1)),this.layer.fire("layerload")},e.prototype.drawOnInteracting=function(){this._isVisible()&&this._ec.resize()},e.prototype.needToRedraw=function(){var t=this.getMap(),e=t._getRenderer();return t.isInteracting()||e&&(e.isStateChanged&&e.isStateChanged()||e.isViewChanged&&e.isViewChanged())},e.prototype.getMap=function(){return this.layer.getMap()},e.prototype._isVisible=function(){return this._container&&""===this._container.style.display},e.prototype.show=function(){this._container&&(this._container.style.display="")},e.prototype.hide=function(){this._container&&(this._container.style.display="none")},e.prototype.remove=function(){this._ec.clear(),this._ec.dispose(),delete this._ec,this._removeLayerContainer()},e.prototype.clear=function(){this._ec.clear()},e.prototype.setZIndex=function(t){this._zIndex=t,this._container&&(this._container.style.zIndex=t)},e.prototype.isCanvasRender=function(){return!1},e.prototype._prepareECharts=function(){this._registered||(i.registerCoordinateSystem("maptalks",this._getE3CoordinateSystem(this.getMap())),this._registered=!0);var t=this.layer._ecOptions.series;if(t)for(var e=t.length-1;0<=e;e--)t[e].coordinateSystem="maptalks",t[e].animation=!1},e.prototype._createLayerContainer=function(){var t=this._container=o.DomUtil.createEl("div");t.style.cssText="position:absolute;left:0px;top:0px;",this._zIndex&&(t.style.zIndex=this._zIndex),this._resetContainer(),("front"===this.layer.options.container?this.getMap()._panels.frontStatic:this.getMap()._panels.backStatic).appendChild(t)},e.prototype._removeLayerContainer=function(){this._container&&o.DomUtil.removeDomNode(this._container),delete this._levelContainers},e.prototype._resetContainer=function(){var t=this.getMap().getSize();this._container.style.width=t.width+"px",this._container.style.height=t.height+"px"},e.prototype._getE3CoordinateSystem=function(e){var n=function(t){this.map=t,this._mapOffset=[0,0]};return n.create=function(t){t.eachSeries(function(t){"maptalks"===t.get("coordinateSystem")&&(t.coordinateSystem=new n(e))})},n.getDimensionsInfo=function(){return["x","y"]},n.dimensions=["x","y"],o.Util.extend(n.prototype,{dimensions:["x","y"],setMapOffset:function(t){this._mapOffset=t},dataToPoint:function(t){var e=new o.Coordinate(t),n=this.map.coordinateToContainerPoint(e),i=this._mapOffset;return[n.x-i[0],n.y-i[1]]},pointToData:function(t){var e=this._mapOffset,n=this.map.containerPointToCoordinate({x:t[0]+e[0],y:t[1]+e[1]});return[n.x,n.y]},getViewRect:function(){var t=this.map.getSize();return new i.graphic.BoundingRect(0,0,t.width,t.height)},getRoamTransform:function(){return i.matrix.create()}}),n},e.prototype.getEvents=function(){return{_zoomstart:this.onZoomStart,_zoomend:this.onZoomEnd,_dragrotatestart:this.onDragRotateStart,_dragrotateend:this.onDragRotateEnd,_movestart:this.onMoveStart,_moveend:this.onMoveEnd,_resize:this._resetContainer}},e.prototype.getEC=function(){return this._ec},e.prototype._clearAndRedraw=function(){this._container&&"none"===this._container.style.display||(this._ec.clear(),this._ec.resize(),this._prepareECharts(),this._ec.setOption(this.layer._ecOptions,!1))},e.prototype.onZoomStart=function(){this.layer.options.hideOnZooming&&this.hide()},e.prototype.onZoomEnd=function(){this.layer.options.hideOnZooming&&(this.show(),this._clearAndRedraw())},e.prototype.onDragRotateStart=function(){this.layer.options.hideOnRotating&&this.hide()},e.prototype.onDragRotateEnd=function(){this.layer.options.hideOnRotating&&(this.show(),this._clearAndRedraw())},e.prototype.onMoveStart=function(){this.layer.options.hideOnMoving&&this.hide()},e.prototype.onMoveEnd=function(){this.layer.options.hideOnMoving&&(this.show(),this._clearAndRedraw())},e}()),t.E3Layer=n,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.e3 v0.4.6, requires maptalks@^0.25.0.")});